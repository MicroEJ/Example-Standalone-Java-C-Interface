<?xml version="1.0" encoding="UTF-8"?>
<!--
	ANT file
	Copyright 2013-2015 IS2T. All rights reserved.
	IS2T PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
-->
<!--
	Input properties
-->
<project name="stlink.deploy.stm32f746gdisco">
	
	<property name="stlink.option.flasherase" value="false"/>
	
	<target name="board/deploy/warning" extensionOf="board/deploy" >
		<echo message=""/>
		<echo message="-----------------------------------------------------------------"/>
		<echo message="/!\ This tool requires STM32 ST-Link Utility v3.7.1 or higher /!\"/>
		<echo message="-----------------------------------------------------------------"/>
		<echo message=""/>
	</target>
		
	<target name="board/deploy/convert/flash" extensionOf="board/deploy" if="${application.objcopy.convert}">
		<!-- external flash programming -->
		<condition property="board.deploy.ext.flash.bin" value="true" else="false">
			<and>
				<available file="${deploy.file.dir}/${deploy.file.name}_0x90000000.bin"/>
				<length file="${deploy.file.dir}/${deploy.file.name}_0x90000000.bin" when="ne" length="0"/>
			</and>
		</condition>
		<antcall inheritall="true" inheritrefs="true" target="board/deploy/convert/flash/ext"/>
		<!-- internal flash programming -->
		<stlink.launch file="${deploy.file.dir}/${deploy.file.name}_0x08000000.bin"/>
	</target>
	
	<target name="board/deploy/convert/flash/ext" if="${board.deploy.ext.flash.bin}">
		<stlink.launch file="${deploy.file.dir}/${deploy.file.name}_0x90000000.bin" address="0x90000000" ext.loader="${stlinkutility.installation.dir}/ExternalLoader/N25Q128A_STM32F746G-DISCO.stldr" board.flasherase="${stlink.option.flasherase}"/>
	</target>
	
	<macrodef name="stlink.launch">
		<attribute name="file"/>
		<attribute name="address" default="0x08000000"/>
		<attribute name="ext.loader" default=""/>
		<attribute name="board.id" default="0"/>
		<attribute name="board.flasherase" default="false"/>
		<sequential>
			<ant antfile="stlink.xml" inheritall="false">
				<property name="stlink.binary.file" value="@{file}"/>	
				<property name="stlink.option.dir" value="${stlinkutility.installation.dir}"/>	
				<property name="stlink.binary.address" value="@{address}"/>	
				<property name="stlink.ext.loader" value="@{ext.loader}"/>
				<property name="stlink.option.id" value="@{board.id}"/>	
				<property name="stlink.option.flasherase" value="@{board.flasherase}"/>	
			</ant>
		</sequential>
	</macrodef>
</project>
