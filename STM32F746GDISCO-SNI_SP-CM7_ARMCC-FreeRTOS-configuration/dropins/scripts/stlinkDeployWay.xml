<?xml version="1.0" encoding="UTF-8"?>
<!--
	ANT
	
	Copyright 2013-2015 IS2T. All rights reserved.
	IS2T PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
-->

<project name="flashMagicDeployWay" default="board">

	<description>Deploy a binary file on STM32xxGEVAL boards using the STLink probe.</description>

	<property name="tools.dir" location="${platform.dir}/tools"/>
	<path id="elfutils.classpath.path">
		<fileset dir="${tools.dir}" includes="elfutils.jar"/>
	</path>
	<taskdef name="objcopy" classname="com.is2t.elf.utils.ObjcopyTask" classpathref="elfutils.classpath.path"/>
	
	
	<extension-point name="board/deploy"/>
	
	<target name="board" depends="board/deploy/init, board/deploy"/>

	<target name="board/deploy/init">
		<condition property="application.objcopy.convert" value="true" else="false">
			<contains string="${deploy.binary.file}" substring=".out" casesensitive="false"/>
		</condition>
	</target>

	<target name="board/deploy/convert" extensionOf="board/deploy" if="${application.objcopy.convert}">
		<dirname file="${deploy.binary.file}" property="deploy.file.dir"/>
		<basename file="${deploy.binary.file}" property="deploy.file.name" suffix=".out"/>
		<property name="deploy.file" location="${deploy.file.dir}/${deploy.file.name}_0x80000000.bin"/>
		
		<objcopy 
			executableFile="${deploy.binary.file}"
			outputDir="${deploy.file.dir}"
			outputName="${deploy.file.name}"
			suffix=".bin"
		/>
		
		<ant antfile="stlink.xml" inheritall="false">
			<property name="stlink.binary.file" value="${deploy.file}"/>		
		</ant>
		<delete file="${deploy.file}"/>
	</target>
	
	<target name="board/deploy/noconvert" extensionOf="board/deploy" unless="${application.objcopy.convert}">
		<ant antfile="stlink.xml" inheritall="false">
			<property name="stlink.binary.file" value="${deploy.binary.file}"/>		
		</ant>
	</target>

</project>
